#!/bin/sh

echo "ğŸ” Running ESLint before push..."

# æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ¨é€çš„æäº¤
commits_to_push=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo "0")

if [ "$commits_to_push" = "0" ]; then
    echo "â„¹ï¸  No new commits to push, but running full ESLint check..."
    npm run lint
else
    echo "ğŸ“ Found $commits_to_push commit(s) to push"
    
    # è·å–è¦æ¨é€çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåªæ£€æŸ¥ .ts å’Œ .tsx æ–‡ä»¶ï¼‰
    files_to_check=$(git diff --name-only @{u}..HEAD | grep -E '\.(ts|tsx)$' | tr '\n' ' ')
    
    if [ -n "$files_to_check" ]; then
        echo "ğŸ” Checking modified TypeScript files: $files_to_check"
        npx eslint $files_to_check
    else
        echo "â„¹ï¸  No TypeScript files to check in push commits"
        exit 0
    fi
fi

# æ£€æŸ¥ ESLint çš„é€€å‡ºçŠ¶æ€
if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ ESLint check failed. Push aborted."
    echo "Please fix the linting errors before pushing."
    echo ""
    echo "To fix errors automatically (where possible), run:"
    echo "  npm run lint:fix"
    echo ""
    echo "To bypass this check (not recommended), run:"
    echo "  git push --no-verify"
    exit 1
fi

echo "âœ… ESLint check passed. Proceeding with push..." 